# Disk Management

> 2021.11.22

## 磁盘分区
``` bash
# 查看分区信息方法：
# 1
$ sudo fdisk /dev/sda (recommend)
# 2  
$ lsblk
# 3
$ df -h
```



## 磁盘分区类型
在Linux系统中，磁盘有两种使用方式：标准分区(又称基本磁盘)和LVM逻辑卷管理(又称动态磁盘)。
磁盘的标准分区方式，分区时有以下三种分区类型：

1. 主分区：允许装系统的分区，一块磁盘最多允许分4个主分区
2. 扩展分区：不可以直接使用，即不允许存入数据；占主分区的一个名额
3. 逻辑分区：必须建立在扩展分区之内，仅用于存数据，不支持安装系统，允许划分多个

可以想象，如果一块磁盘已经划分了4个主分区，但仍然有空闲空间，那么剩余的空闲空间是不允许再分分区的，因为4个主分区的名额已满。所以，一般磁盘的使用方案是：3主+1扩， 扩展的基础上创建多个逻辑分区。即创建3个主分区，磁盘剩余空间都划分给一个扩展分区，这样4个主分区的名额用满。进而再在扩展分区内划分多个逻辑分区

## 磁盘分区名称
hd：IDE硬盘。如果是SCSI硬盘，则为sd，这个只能记住，没有更好的办法。

a:： 第一块硬盘。如果是第二块硬盘，则为b，依此类推c,d……

1： 主分区。其中1，2，3，4都是主分区，从第5开始为逻辑分区，最大到16

**总结**：
- 一块硬盘可以只设主分区，这时主分区可设置4个分区号。
- 也可以设置成主分区+逻辑分区，这时也是最多4个分区号码，但是变成了4=3+1。即主分区和扩展分区加起来最多4个；
- 从5开始到16，都是逻辑分区。如果只有一个5，则扩展分区不再进行分区了，那么扩展分区就是逻辑分区了（扩展分区的磁盘总量等于一个逻辑分区的磁盘总量）。
- 常见的是扩展分区被分成几个逻辑分区，用5，6，7，8等号码标识。


## LVM原理
- PV：物理卷。，可以把一个分区或一块磁盘制作成PV，即一块用于存储数据的磁盘空间。
- VG：卷组。多个PV组成一个PV组
- LV：逻辑卷。从VG中划分出一块存储空间，制作文件系统，并挂载使用。LV允许跨越VG中多个PV的空间。
- PE：物理单元。PV加入到VG时，会按照VG事先制定好的固定大小，划分成n多个存储单元，称为PE
- LE：逻辑单元。从VG中划分出LV时，是按照LV的大小，从VG中划分出足够多的PE给LV使用，被LV所占用的PE，在LV中称为LE。即LE是PE在LV中的映射。


## Swap分区
### 限制大小原理
Swap空间是分页的，每一页的大小和内存页的大小一样，方便Swap空间和内存之间的数据交换。旧版本的Linux实现Swap空间时，用Swap空间的第一页作为所有Swap空间页的一个“位映射”（Bit map）。这就是说第一页的每一位，都对应着一页Swap空间。如果这一位是1，表示此页Swap可用；如果是0，表示此页是坏块，不能使用。这么说来，第一个Swap映射位应该是0，因为，第一页Swap是映射页。另外，最后10个映射位也被占用，用来表示Swap的版本（原来的版本是Swap_space ，最新的版本是swapspace2）。那么，如果说一页的大小为s，这种Swap的实现方法共能管理“8 * ( s - 10 ) - 1”个Swap页。对于i386系统来说s=4096，则空间大小共为133890048，如果认为1 MB=2^20 Byte的话，大小正好为128M。
之所以这样来实现Swap空间的管理，是要防止Swap空间中有坏块。如果系统检查到Swap中有坏块，则在相应的位映射上标记上0，表示此页不可用。这样在使用Swap时，不至于用到坏块，而使系统产生错误。

```
系统设计者认为：
- 硬盘质量很好，坏块很少。
- 就算有，也不多，只需要将坏块罗列出来，而不需要为每一页建立映射。
- 如果有很多坏块，就不应该将此硬盘作为Swap空间使用。
于是，Linux取消了位映射的方法，也就取消了128M的限制。直接用地址访问，限制为2G。
```

### Swap配置对性能的影响
- **分配太多的Swap空间会浪费磁盘空间，而Swap空间太少，则系统会发生错误。**  
    如果系统的物理内存用光了，系统就会跑得很慢，但仍能运行；如果Swap空间用光了，那么系统就会发生错误。例如，Web服务器能根据不同的请求数量衍生出多个服务进程（或线程），如果Swap空间用完，则服务进程无法启动，通常会出现“application is out of memory”的错误，严重时会造成服务进程的死锁。因此Swap空间的分配是很重要的。
- **通常情况下，Swap空间应大于或等于物理内存的大小，最小不应小于64M，通常Swap空间的大小应是物理内存的2-2.5倍。**  
    但根据不同的应用，应有不同的配置：如果是小的桌面系统，则只需要较小的Swap空间，而大的服务器系统则视情况不同需要不同大小的Swap空间。特别是数据库服务器和Web服务器，随着访问量的增加，对Swap空间的要求也会增加，具体配置参见各服务器产品的说明。